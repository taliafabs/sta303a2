---
editor_options: 
  markdown: 
    wrap: 72
---

```{r pmisc}
if (!requireNamespace("Pmisc", quietly = TRUE)) {
  install.packages("Pmisc", repos = "http://r-forge.r-project.org")
}

library(Pmisc)
```

Importing the Data:

```{r}
heatUrl = "http://pbrown.ca/teaching/appliedstats/data/sableIsland.rds"
dir.create("cache", showWarnings = FALSE)
heatFile = file.path("cache", basename(heatUrl))

if (!file.exists(heatFile)) 
  download.file(heatUrl, heatFile)

x = readRDS(heatFile)
names(x) = gsub("[.]+C[.]", "", names(x))
x$Date = as.Date(x$Date)
x$month = as.numeric(format(x$Date, "%m"))
x$summer = x$month %in% 5:10
```

Code for 3 GAM:

```{r}
x[100, ]
x$dateInt = as.integer(x$Date)
x$yearFac = factor(format(x$Date, "%Y"))

xSub = x[x$summer & !is.na(x$Max.Temp), ]

library("mgcv")

# Model 1 (res1)
res1 = gam(update.formula(
  Max.Temp ~ s(dateInt, pc = as.integer(as.Date("1990/7/1")), k = 100) + 
  s(yearFac, bs = "re"), 
  Pmisc::seasonalFormula(period = 365.25, harmonics = 1:2, var = "dateInt")
), data = xSub, method = "ML", optimizer = "efs")

summary(res1)

# Model 2 (res2)
res2 = gam(update.formula(
  Max.Temp ~ s(dateInt, pc = as.integer(as.Date("1990/7/1")), k = 4) + 
  s(yearFac, bs = "re"), 
  Pmisc::seasonalFormula(period = 365.25, harmonics = 1:2, var = "dateInt")
), data = xSub, method = "ML", optimizer = "efs")

# Model 3 (res3)
res3 = gam(update.formula(
  Max.Temp ~ s(dateInt, pc = as.integer(as.Date("1990/7/1")), k = 100), 
  Pmisc::seasonalFormula(period = 365.25, harmonics = 1:2, var = "dateInt")
), data = xSub, method = "ML", optimizer = "efs")

# Output the formula of res1
res1$formula
res2$formula
res3$formula

summary(res1)

```

Q1: #Write down a set of equations (or several sets of equations) which
corresponds to the three calls to gam. #Explain the differences between
the models in res1, res2 and res3? (2 points)

##Discussion: res 1 and res 3 have a k value equal to 100, this is a
component of the smooth term. Due to the k value being greater in these
2 models, compared to res 2 having a k value of 4 in the smooth term,
res1 and res3 will be able to capture more of the data, allowing more
flexibility in the smooth function. For res 2 with a k value of 4 the
smooth term will have a more generalized shape, not accounting for
detailed variability in the data.

Another key difference is that Res3 does not include yearFac as a random
effect, whereas Res1 and Res2 both treat yearFac as a random effect.
This means that in Res3, the model assumes that the intercept for
Max.Temp is the same for all years. However, this assumption is likely
not accurate, as temperatures can vary significantly from year to year,
especially over long periods. By including yearFac as a random effect,
Res1 and Res2 allow for different intercepts for each year, better
capturing year-to-year variations in the data.

Set of Equations for the models 
$$ 
Res1:\\ Y_i
\sim \mathcal{N}(\mu\_i, \sigma\^2)\\

\mu\_i = f_1(\text{dateInt}) + f_2(\text{yearFac}) +
f_3(\text{seasonal1}) + f_4(\text{seasonal2})\\ Where:\\
f_1(\text{dateInt}) = s(\text{dateInt}, \text{pc} =
\text{as.integer(as.Date("1990/7/1"))}, k = 100) \\ f_2(\text{yearFac})
= s(\text{yearFac}, \text{bs} = "re") \\ s_1(\text{seasonal1}) =
\sin\left(\frac{\pi \cdot \text{dateInt}}{182.625}\right) +
\cos\left(\frac{\pi \cdot \text{dateInt}}{182.625}\right) \\
s_2(\text{seasonal2}) =
\sin\left(\frac{\pi \cdot \text{dateInt}}{91.3125}\right) +
\cos\left(\frac{\pi \cdot \text{dateInt}}{91.3125}\right)
$$

$$ 
\text{Res2:} \\ Y_i \sim \mathcal{N}(\mu\_i, \sigma\^2) \\ \mu\_i =
f_1(\text{dateInt}) + f_2(\text{yearFac}) + f_3(\text{seasonal1}) +
f_4(\text{seasonal2}) \\ \text{Where:} \\ f_1(\text{dateInt}) =
s(\text{dateInt}, \text{pc} = \text{as.integer(as.Date("1990/7/1"))}, k
= 4) \\ f_2(\text{yearFac}) = s(\text{yearFac}, \text{bs} = "re") \\
f_3(\text{seasonal1}) =
\sin\left(\frac{\pi \cdot \text{dateInt}}{182.625}\right) +
\cos\left(\frac{\pi \cdot \text{dateInt}}{182.625}\right) \\
f_4(\text{seasonal2}) =
\sin\left(\frac{\pi \cdot \text{dateInt}}{91.3125}\right) +
\cos\left(\frac{\pi \cdot \text{dateInt}}{91.3125}\right) 
$$

$$ 
\text{Res3:} \\ Y_i \sim \mathcal{N}(\mu\_i, \sigma\^2) \\ \mu\_i =
f_1(\text{dateInt}) + f_2(\text{seasonal1}) + f_3(\text{seasonal2}) \\
\text{Where:} \\ f_1(\text{dateInt}) = s(\text{dateInt}, \text{pc} =
\text{as.integer(as.Date("1990/7/1"))}, k = 100) \\
f_2(\text{seasonal1}) =
\sin\left(\frac{\pi \cdot \text{dateInt}}{182.625}\right) +
\cos\left(\frac{\pi \cdot \text{dateInt}}{182.625}\right) \\
f_3(\text{seasonal2}) =
\sin\left(\frac{\pi \cdot \text{dateInt}}{91.3125}\right) +
\cos\left(\frac{\pi \cdot \text{dateInt}}{91.3125}\right) 
$$

##Q2:
Maxine Burningier, leader of the People's Party of Canada, sees fig. 3 c
and proclaims in a post on Truth Social that "There is no clear evidence
of global temperature increase! Model 3 is the best model and it shows
these data are only noise!' ' Write a short (3 or 4 sentence) letter to
the editor of your local tabloid newspaper either providing scientific
justification for the Esteemed Leader's statement or explaining clearly
why you disagree.

# Response
The claim that there is no clear evidence of global temperature increase overlooks the data showing a clear increasing trend in maximum temperature, especially in recent years, as shown by Models 1 and 2, which account for the random effect of year on maximum temperature variations. Model 3 is not the best model, as it does not include the random effect of year, which fails to account for the possibility that some years may have consistently higher or lower maximum temperatures than others, potentially missing important conclusions. Concluding that maximum temperatures have increased over time should not be discredited simply because some years have experienced lower maximum temperatures than others. The frequency of high maximum temperatures in recent years clearly captures the increase in temperature when accounting for year-to-year variation as a random effect.

##Q3: 
Create a nicer version of fig. 4, with axis labels and an
informative caption. You can refer to variables given in the equations
from Question 1. The caption should be two or three sentences, a reader
familiar with generalized additive models should understand everything
about the figure (even if they have not read this homework assignment)
(3 points)

```{r}
View(xSub)
Syear = unique(xSub$yearFac)

predYear = do.call(cbind, predict(res1, 
                                  newdata = data.frame(yearFac = Syear, dateInt = 0), 
                                  type = "terms", 
                                  terms = "s(yearFac)", 
                                  se.fit = TRUE)) %*% Pmisc::ciMat()

newdat = data.frame(Date = seq(as.Date("1900/1/1"), as.Date("2035/12/31"), by = "2 weeks"), 
                    yearFac = Syear[1])

newdat$dateInt = as.integer(newdat$Date)

predTrend = do.call(cbind, predict(res1, 
                                   newdat, 
                                   type = "terms", 
                                   terms = "s(dateInt)", 
                                   se.fit = TRUE)) %*% Pmisc::ciMat()

newX = predict(res1, newdata = newdat, type = "lpmatrix")

simCoef <- rmvn(10, coef(res1), vcov(res1))

isTrend = grep("s[(]dateInt", colnames(newX))

simTrend = tcrossprod(newX[, isTrend], simCoef[, isTrend])

Syear = as.numeric(as.character(Syear))

View(xSub)

View(predYear)

baseline_temp <- xSub[xSub$Date == as.Date("1990/7/1"), "Max.Temp"]

```

# Plotting
```{r, fig.cap="The first plot shows the prediction intervals for the random effect of the year on maximum temperature, illustrating the predicted unexplained variation by year. The baseline year is 1990, so positive predicted year factor values indicate that maximum temperatures are expected to be higher in those specific years. Conversely, values below zero indicate that maximum temperatures are expected to be lower than the baseline year (1990).The second plot presents several simulated trends of the smoothing effect based on the seasonal variations in max temperature. The plot shows how the maximum temperature has increased over time. The trend in the second plot shows there has been more extreme max temperatures over the past 20 years."}

## Plotting


# First plot: Predicted random effect
matplot(Syear, predYear, 
        xlab = "Year", 
        ylab = "Year Effect on Max Temperature", 
        pch = 16, 
        col = "black",
        cex.lab = 0.8)
segments(Syear, predYear[, 2], Syear, predYear[, 3], lwd = 0.5)
mtext("a) ", side = 1, line = 4, at = mean(Syear), cex = 0.8)

# Second plot: Simulated temperature trends
matplot(newdat$Date, simTrend, 
        type = "l", 
        lty = 1, 
        col = RColorBrewer::brewer.pal(ncol(simTrend), "Paired"), 
        xaxt = "n", 
        xaxs = "i", 
        yaxs = "i", 
        ylim = range(predTrend),
        ylab = "Simulated Max Temperature Trend (ºC)", 
        xlab = "Year",
        cex.lab = 0.8)


matlines(newdat$Date, predTrend, 
         lty = c(1, 2, 2), 
         col = "black", 
         lwd = 2)

# Custom x-axis
forX = as.Date(ISOdate(seq(1880, 2050, by = 25), 1, 1))
axis(1, forX, format(forX, "%Y"))
mtext("b) ", side = 1, line = 4, at = mean(newdat$Date), cex = 0.8)
```

##Q4
David Thompson found a clear evidence of global warming in these data in 1996. Re-fit the model
using only data from 1995 and earlier and compare that model’s forecasts to the observed data from
1996-2025. Is the People’s Party of Canada correct in saying “Climate change alarmism is based on
flawed models that have consistently failed at correctly predicting the future.” (3 points)
```{r}
xnew = x[x$Date <= as.Date("1995-12-31") & !is.na(x$Max.Temp), ]


##Fitting the new model
res_new <- gam(update.formula(
  Max.Temp ~ s(dateInt,pc = as.integer(as.Date("1930/7/1")), k = 50) +
    s(yearFac, bs = "re"), 
  Pmisc::seasonalFormula(period = 365.25, harmonics = 1:2, var = "dateInt")
), data = xnew, method = "ML", optimizer = "efs")
```

```{r}
# forecast
jan_1_1996 = as.Date('1996/1/1')
jan_1_2025 = as.Date('2025/1/1')
X_forecast = data.frame(
  date = seq(jan_1_1996, jan_1_2025, by='month'),
  month='Mar')
X_forecast$dateInt = as.integer(X_forecast$date)

pred4 = do.call(
  cbind,
  predict(tempGAM1996, X_forecast, se.fit=TRUE)
  ) %*% Pmisc::ciMat()

pred4 = do.call(
  cbind,
  predict(xnew, X_forecast, se.fit=TRUE)
  ) %*% Pmisc::ciMat()

matplot(X_forecast$date, pred4,
        lty=c(1,2,2),
        col='red',
        xlim = c(jan_1_1996, jan_1_2025),
        xlab='',
        ylab = 'temperature'
        )

# plot the actual data points
points(xSub$Date, xSub$Max.Temp, cex=0.3)

# plot the trend?????
abline(v=max(res_new$model$dateInt))
```
plotting predicted
```{r}
pred3 = do.call(cbind, predict(
  res_new, xnew, se.fit = TRUE)
) %*% Pmisc::ciMat()

matplot(xnew$yearFac, exp(pred3),
        lty = c(1, 2, 2), col = 'red',
        xlim = as.Date(c('1996/1/1', '2025/03/05')),
        ylim = c(8, 14) * 1000,
        log = 'y', type = 'l', xlab = '',
        ylab = 'Max.Temp')

points(xnew$dateInt, xnew$Max.Temp, cex = 0.3)
abline(v = max(deathsGam2020$model$dateInt))
```
Plotting Observed Values:
```{r}
xn = x[x$Date >= as.Date("1996-01-01") & !is.na(x$Max.Temp), ]

plot(xn$Date, xn$Max.Temp, 
     main = "Observed values of Max Temperature from 1996 to 2025",
     xlab = "Year", 
     ylab = "Max Temperature", 
     pch = 16, 
     col = ifelse(x$summer, "red", "black"))
```
Plotting Predicted values:
```{r}
Syear = unique(xnew$yearFac)

predYear <- do.call(cbind, predict(
  res_new, 
  newdata = data.frame(yearFac = Syear, dateInt = 0), 
  type = "terms", 
  terms = "s(yearFac)", 
  se.fit = TRUE
)) %*% Pmisc::ciMat()

# Create a new data frame with a sequence of dates every 2 weeks
newdat <- data.frame(
  Date = seq(as.Date("1996-01-01"), as.Date("2025-12-31"), by = "2 weeks"),
  yearFac = Syear[1]
)

# Convert Date to an integer representation
newdat$dateInt <- as.integer(newdat$Date)

# Predict trend with confidence intervals
predTrend <- do.call(cbind, predict(
  res_new, newdat, type = "terms", terms = "s(dateInt)", se.fit = TRUE
)) %*% Pmisc::ciMat()

# Generate the design matrix for new data
newX <- predict(res_new, newdata = newdat, type = "lpmatrix")

# Simulate coefficients from the model’s variance-covariance matrix
simCoef <- rmvn(10, coef(res_new), vcov(res_new))

# Identify columns corresponding to the smooth term s(dateInt)
isTrend <- grep("s\\(dateInt", colnames(newX))

# Compute simulated trend values
simTrend <- tcrossprod(newX[, isTrend], simCoef[, isTrend])

```

```{r}
Syear <- as.numeric(as.character(Syear))

matplot(
  Syear, predYear, xlab = "Degrees C", cex = c(1, 0, 0), 
  pch = 16, col = "black"
)

segments(Syear, predYear[, 2], Syear, predYear[, 3], lwd = 0.5)

matplot(
  newdat$Date, simTrend, type = "l", lty = 1, 
  col = RColorBrewer::brewer.pal(ncol(simTrend), "Paired"), 
  xaxt = "n", xaxs = "i", yaxs = "i", ylim = range(predTrend), 
  xlab = ""
)

matlines(newdat$Date, predTrend, lty = c(1, 2, 2), col = "black", lwd = 2)

forX <- as.Date(ISOdate(seq(1996, 2025, by = 2), 1, 1))
axis(1, forX, format(forX, "%Y"))

```
```{r}
xpred <- data.frame(
  dateInt = as.integer(seq(as.Date("1996-01-01"), as.Date("2025-12-31"), by = "day")),
  yearFac = factor(format(seq(as.Date("1996-01-01"), as.Date("2025-12-31"), by = "day"), "%Y"))  # Ensure factor type matches model
)
predictions <- predict(res_new, newdata = xpred, se.fit = False)


```