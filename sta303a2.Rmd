---
title: "STA303 Assignment 2"
author: 
- Talia Fabregas
- Kasandra Tworzynaski
date: \today
date-format: long
number-sections: true
output: pdf_document
---

# Q1: Motorcycle deaths

```{r pmisc, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# if pmisc is more than a week old, fetch the latest 
if(!requireNamespace("Pmisc", quietly=TRUE)) {
	install.packages("Pmisc", repos='http://r-forge.r-project.org')
}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
library(Hmisc)
library(Pmisc)
# install.packages("mcgv")
library(mgcv)
library(kableExtra)
library(janitor)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}
# retrieving the data
theUrl = "http://pbrown.ca/teaching/appliedstats/data/motorcycle.rds"
theFile = basename(theUrl)
if (!file.exists(theFile)) download.file(theUrl, theFile)
x = readRDS(theFile)

# preparing the data
x$dateInt = as.integer(x$date)
x$logMonthDays = log(Hmisc::monthDays(x$date))
x$month = factor(format(x$date, "%b"), levels = format(ISOdate(2000,
+   1:12, 1), "%b"))
res = glm(killed ~ offset(logMonthDays) + dateInt + month, data = x, 
          family = poisson(link = "log")
          )
newdata = data.frame(date = seq(as.Date("1975/1/1"), as.Date("2030/1/1"), by = "month"))
newdata$dateInt = as.integer(newdata$date)
newdata$logMonthDays = log(30)
newdata$month = "Mar"
pred1 = predict(res, newdata)
newdata$month = format(newdata$date, "%b")
pred2 = predict(res, newdata)
plot(x$date, x$killed, cex = 0.2, log = "y", xlab = "", ylab = "")
matlines(newdata$date, exp(cbind(pred1, pred2)), lty = 1)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
head(x)
```

#### 1. Write down, in equations not R code, a generalized additive model suitable for this problem. Explain each of the parts of the model and give a rationale for them (i.e. “The response variable is Gamma distributed because the number of deaths must be positive”). (4 points)

<!-- Do we have to check for overdispersion or is this already telling us it is poission? -->

<!-- Number of motorcylcle deaths every month from 1980 to 2025 -->

<!-- An appropriate generalized additive model -->

<!-- We chose a poisson because the response variable, the number of motorcycle deaths in month i, is a count variable. -->
Negbinom can adapt to very low overdispersion
<!-- Covariate Xi is month -->
<!-- Beta is the fixed effect of month -->

  $$
    Y_i | U  \sim Pois(D_i \lambda_i) \\
    \text{log}(\lambda_i) = X_i \beta + U(t_i) \\
    U(.) \sim IWP_2(\sigma)
  $$

where:

-   $Y_i$ = the number of motorcycle deaths in month $i$

-   $D_i$ = the number of days in month $i$

-   $\lambda_i$ = intensity of expected number of deaths

-   $X_i$ = month indicator variables (seasonality, month as a factor)

-   $\beta$ = fixed month effect

-   $U(t_i)$ = smooth term, second-order Integrated Wiener Process (IWP)

The response variable, $Y_i$, is Poisson because the number of motorcycle deaths is a non-negative count variable. $D_i$ is the number of deaths in month $i$ and $\lambda_i$ is the intensity. We will use $D_i$ as an offset because exposure time varies by the length of the month (i.e. February has 28 or 29 days and January has 31 days). The log link function ensures that the predicted counts are non-negative and creates a multiplicative relationship between the predictors and response. 

Sesonal components like pi cos or sin should be written down -- explain how seasonal components are being structured. be more specific. define seasonal component be as specific as possible

#### 2. Show R code to fit the model using the `mcgv` package

```{r, echo=TRUE, message=FALSE, warning=FALSE}
model1 <- mgcv::gam(update.formula(killed ~ s(dateInt, k=4) + month + offset(logMonthDays),
              Pmisc::seasonalFormula(period=365.25, harmonics=1:2, var='dateInt')),
              data=x,
              family=nb(link=log),
              method = 'ML'
              )

# model2 <- mgcv::gam(killed ~ s(dateInt, k=4) + month + offset(logMonthDays),
#               data=x,
#               family=poisson(link=log),
#               method = 'ML'
#               )
```

#### 3. Produce a figure similar to Figure fig. 1 which is able to visualize the trend estimated from the motorcycle data. You’re marked on the figure looking professional (with clear labels and a caption) as well as conveying the important statistical information (prediction intervals as well as point predictions). (4 points)

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=TRUE, fig.cap="Motorcycle deaths have declined over time, since 1980."}
# predicted trend
plot(x$date, 
     x$killed,
     col='darkgray', 
     log='y',
     xlab='', 
     ylab='Motorcycle deaths',
     cex=0.4
     )

# seasonal
matlines(x$date, 
         exp(do.call(cbind, predict(model1, se.fit=TRUE)) %*% Pmisc::ciMat(0.95)),
         lty=c(1,2,2), col='#377eb8'
         
)

# problem is here
# # march
newX = x; newX$month = 'Mar'
newX$logMonthDays = log(31)

matlines(newX$date,
         exp(do.call(cbind, predict(model1, newX, se.fit=TRUE)) %*% Pmisc::ciMat(0.95)),
         lty = c(1, 2, 2),
         col='red3',
         lwd = c(1.5, 1, 1)
         )

# prediction rate mu_i (red), seasonally adjusted trend (red) with 95% prediction intervals
```

# Q2: Heat

#### 1.

#### 2.

#### 3.

#### 4.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
x[100, ]
```

`{r. echo=FALSE, message=FALSE, warning=FALSE} x$dateInt = as.integer(x$Date) x$yearFac = factor(format(x$Date, "%Y")) # xSub = x[x$summer & !is.na(x$Max.Temp), ] # res1 = gam(update.formula(Max.Temp ~ s(dateInt, pc = as.integer(as.Date("1990/7/1")), # +   k = 100) + s(yearFac, bs = "re"), Pmisc::seasonalFormula(period = 365.25, # +   harmonics = 1:2, var = "dateInt")), data = xSub, method = "ML", # +   optimizer = "efs")`
