```{r}
##For Question 1:

##Uploading
theUrl = "http://pbrown.ca/teaching/appliedstats/data/motorcycle.rds"
theFile = basename(theUrl)
if (!file.exists(theFile)) download.file(theUrl, theFile)
x = readRDS(theFile)

#install.packages('mgcv')
#library(mgcv)
#install.packages("htmltools")

#remove.packages("htmltools")
#install.packages("htmltools")

#install.packages("remotes")
#remotes::install_version("htmltools", version = "0.5.7")


# Convert date to integer representation
x$dateInt <- as.integer(x$date)

# Compute log of the number of days in each month
x$logMonthDays <- log(Hmisc::monthDays(x$date))

# Extract month as a factor with proper ordering
x$month <- factor(
  format(x$date, "%b"), 
  levels = format(ISOdate(2000, 1:12, 1), "%b")
)

# Fit a Poisson regression model with a log link
res <- glm(
  killed ~ offset(logMonthDays) + dateInt + month, 
  data = x, 
  family = poisson(link = "log")
)

# Create a new dataset for prediction
newdata <- data.frame(
  date = seq(as.Date("1975/1/1"), as.Date("2030/1/1"), by = "month")
)

# Transform new data similar to original dataset
newdata$dateInt <- as.integer(newdata$date)
newdata$logMonthDays <- log(30)

# First prediction: using March as the month
newdata$month <- "Mar"
pred1 <- predict(res, newdata)

# Second prediction: using the actual month of each date
newdata$month <- format(newdata$date, "%b")
pred2 <- predict(res, newdata)

# Plot original data
plot(
  x$date, x$killed, 
  cex = 0.2, log = "y", 
  xlab = "", ylab = ""
)

# Add predicted lines to the plot
matlines(
  newdata$date, exp(cbind(pred1, pred2)), 
  lty = 1
)

```

Questions:

1) Discussion:
A negative binomial model is used to account for overdispersion in the data. Due to seasonality, deaths may be more frequent in certain months, making the Poisson model less suitable, as it assumes equal variance across observations. Since the negative binomial model is designed for count data, it ensures that predicted death counts remain non-negative.

The dateInt variable serves as a smoothing term to capture nonlinear trends in the data, allowing for more detailed patterns. The month term is included as a covariate to account for monthly variations in death counts.

Additionally, an offset term is incorporated to adjust for differences in observation periods across months, as months with more days may naturally have higher death counts.
```{r}
#2)
library('mgcv')
fittedmodel = gam(
  killed ~ month + s(dateInt) + offset(logMonthDays), 
  family = nb,  
  method = 'ML', 
  data = x
)

```

3) Produce a figure similar to Figure fig. 1 which is able to visualize the trend estimated from the
motorcycle data. Youâ€™re marked on the figure looking professional (with clear labels and a caption) as
well as conveying the important statistical information (prediction intervals as well as point predictions).

Discussion:
There has been an overall decline in deaths overtime, since the highest levels were seen around 1980.
The red line trend shows there are seasonal variations in the number of deaths in the month. The points in black appear to be modeled well by the trend in red.

#**Questions for prof:
#- How should we choose which month to represent in black?
# - how do we convey the prediction intervals and point predictions
```{r}
##3 
# First prediction: using March as the month
newdata$month <- "Mar"
predx <- predict(fittedmodel, newdata)

# Second prediction: using the actual month of each date
newdata$month <- format(newdata$date, "%b")
predy <- predict(fittedmodel, newdata)

# Plot original data
plot(
  x$date, x$killed, 
  cex = 0.2, log = "y", 
  xlab = "Year", ylab = "Number of Deaths"
)

# Add predicted lines to the plot
matlines(
  newdata$date, exp(cbind(predx, predy)), 
  lty = 1
)
```